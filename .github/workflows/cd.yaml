name: Continuous Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'manifests/**'

jobs:

  deploy:
    runs-on: self-hosted
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      
    - name: Configure Flux
      run: |
        flux bootstrap --components-extra=image-reflector-controller,image-automation-controller github \
          --owner=${{ github.repository_owner }} \
          --repository=${{ github.event.repository.name }} \
          --branch=main \
          --path=./bootstrap \
          --read-write-key \
          --personal
          
    - name: Update Kustomization
      run: |
        flux create kustomization app \
          --target-path=./manifests \
          --source=flux-system \
          --prune=true \
          --interval=5m \
          --export > ./bootstrap/kustomization.yaml
          
    - name: Commit and Push
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add -A
        git commit -m "Update manifests"
        git push
